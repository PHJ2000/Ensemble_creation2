<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•©ì£¼ ìƒì„± í™”ë©´</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/compose_start.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <script>
        let mediaRecorder, audioChunks = [], recordingTimeout, audioBlob, audioUrl;

        // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ì´ì „ í˜ì´ì§€ë¡œ ëŒì•„ê°
        function goBack() {
            window.history.back();
        }

        // ë…¹ìŒ ì‹œì‘ í•¨ìˆ˜
        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);

                    mediaRecorder.onstop = () => {
                        audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        audioUrl = URL.createObjectURL(audioBlob);
                        const audio = new Audio(audioUrl);
                    };

                    mediaRecorder.start();
                    console.log('ë…¹ìŒ ì‹œì‘');
                    recordingTimeout = setTimeout(pauseOrStopRecording, 30000); // 30ì´ˆ í›„ ìë™ ì •ì§€

                    // UI ìƒíƒœ ì—…ë°ì´íŠ¸
                    smoothTransition('.record-button', '.pause-button');
                    document.querySelector('.title').style.display = 'none';
                    document.querySelector('.recording-message').style.display = 'block';
                    document.querySelector('.next-button').style.display = 'none';
                    document.getElementById('beatSample').style.display = 'none';
                    document.querySelector('.trigger-image').style.display = 'none';
                    document.querySelector('.back-button').style.display = 'none';
                })
                .catch(error => console.error('ë§ˆì´í¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', error));
        }

        // ìš”ì†Œì˜ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜
        function smoothTransition(hideSelector, showSelector) {
            const hideElement = document.querySelector(hideSelector);
            const showElement = document.querySelector(showSelector);

            hideElement.classList.add('fade-out');
            setTimeout(() => {
                hideElement.style.display = 'none';
                showElement.style.display = 'block';
                showElement.classList.add('fade-in');
            }, 200);
        }

        // ë…¹ìŒ ì¼ì‹œì •ì§€ ë˜ëŠ” ì •ì§€ í•¨ìˆ˜
        function pauseOrStopRecording() {
            if (mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                clearTimeout(recordingTimeout);
                console.log('ë…¹ìŒ ì¤‘ì§€');

                // UI ìƒíƒœ ì—…ë°ì´íŠ¸
                document.querySelector('.pause-button').style.display = 'none';
                document.querySelector('.play-button').style.display = 'block';
                document.querySelector('.recording-message').style.display = 'none';
                const title = document.querySelector('.title');
                title.innerText = 'Click to listen to your recorded instrument sound';
                document.querySelector('.next-button').style.display = 'block';
                title.classList.add('fade-in');
                title.style.display = 'block';
                document.getElementById('beatSample').style.display = 'none';
                document.querySelector('.trigger-image').style.display = 'none';
                document.getElementById('recordingInfo').style.display = 'none';

                // ë¦¬ì…‹ ë²„íŠ¼ê³¼ ë©”ì‹œì§€ ë³´ì´ê¸°
                document.querySelector('.reset-button').style.display = 'block';
                document.querySelector('.reset-message').style.display = 'block';
                document.querySelector('.back-button').style.display = 'none';
            }
        }

        // ë…¹ìŒ ì¬ìƒ í•¨ìˆ˜
        function playRecording() {
            const audio = new Audio(audioUrl);
            audio.play();
            document.getElementById('beatSample').style.display = 'none';
            document.querySelector('.trigger-image').style.display = 'none';
        }

        // ìŒì› ì¬ìƒ í•¨ìˆ˜
        function playSound(audioFile) {
            const audio = new Audio(audioFile);
            audio.play();
        }

        // ë°•ì ìƒ˜í”Œ í† ê¸€ í•¨ìˆ˜
        function toggleBeatSample() {
            const beatSample = document.getElementById('beatSample');
            const triggerImage = document.querySelector('.trigger-image');
            const newImageSrc = 'static/img/ê½¹ê°€ë¦¬ìºë¦­í„°.png';

            if (triggerImage.getAttribute('src') === 'static/img/ë°•ììºë¦­í„°_ì˜ì–´.svg') {
                triggerImage.setAttribute('src', newImageSrc);
                triggerImage.classList.add('kkangari');
            } else {
                triggerImage.setAttribute('src', 'static/img/ë°•ììºë¦­í„°_ì˜ì–´.svg');
                triggerImage.classList.remove('kkangari');
            }

            if (beatSample.classList.contains('visible')) {
                beatSample.classList.remove('fade-in');
                beatSample.classList.add('fade-out');
                setTimeout(() => {
                    beatSample.classList.remove('visible');
                    beatSample.classList.add('hidden');
                }, 200);
            } else {
                beatSample.classList.remove('hidden');
                beatSample.classList.remove('fade-out');
                beatSample.classList.add('visible', 'fade-in');
            }
        }

        // ë…¹ìŒ ë¦¬ì…‹ í•¨ìˆ˜: í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        function resetRecording() {
            window.location.reload();
        }
    </script>
</head>
<body>
    <img class="screen" src="{{ url_for('static', filename='img/ë°°ê²½í…Œë‘ë¦¬.png') }}" alt="ë°°ê²½ ì´ë¯¸ì§€">
    <h1 class="title">Play instruments to create ensembles</h1>
    <h1 class="recording-message" style="display: none;">Recording your instrument sound...</h1>
    <h1 class="recording-result-message" style="display: none;">Click to listen to your recorded instrument sound</h1>

    <button class="back-button" onclick="goBack()">
        <img src="{{ url_for('static', filename='img/backbutton.png') }}" alt="ë’¤ë¡œê°€ê¸°" class="icon">
    </button>

    <button class="next-button" onclick="newFunction()" style="display: none;">
        <img src="{{ url_for('static', filename='img/nextbutton.png') }}" alt="ë„˜ì–´ê°€ê¸°" class="icon">
    </button>

    <img src="{{ url_for('static', filename='img/ë°•ììºë¦­í„°_ì˜ì–´.svg') }}" alt="ë°•ì ìƒ˜í”Œ ì´ë¯¸ì§€" class="trigger-image" id="triggerImage" onclick="toggleBeatSample();">

    <div class="beat-sample hidden" id="beatSample">
        <button class="icon-button" onclick="playSound('static/audios/ì†Œê³ ìƒ˜í”Œ1.mp3')">
            <img src="{{ url_for('static', filename='img/playbutton.png') }}" alt="ìŒì›1" class="circle-icon">
            <span class="sample-text">Sample 1</span>
        </button>
        <button class="icon-button" onclick="playSound('static/audios/ì†Œê³ ìƒ˜í”Œ2.mp3')">
            <img src="{{ url_for('static', filename='img/playbutton.png') }}" alt="ìŒì›2" class="circle-icon">
            <span class="sample-text">Sample 2</span>
        </button>
        <button class="icon-button" onclick="playSound('static/audios/ì†Œê³ ìƒ˜í”Œ3.mp3')">
            <img src="{{ url_for('static', filename='img/playbutton.png') }}" alt="ìŒì›3" class="circle-icon">
            <span class="sample-text">Sample 3</span>
        </button>
    </div>

    <div class="container">
        <div class="record-button" onclick="startRecording()">
            <img src="{{ url_for('static', filename='img/recording_icon.png') }}" alt="ë…¹ìŒ ì‹œì‘" class="record-icon">
        </div>

        <div class="pause-button" style="display: none;" onclick="pauseOrStopRecording()">
            <img src="{{ url_for('static', filename='img/record_stop_button.png') }}" alt="ì¼ì‹œì •ì§€" class="pause-icon">
        </div>

        <div class="play-button" style="display: none;" onclick="playRecording()">
            <img src="{{ url_for('static', filename='img/sound_icon.png') }}" alt="ì¬ìƒ" class="play-icon">
        </div>

        <button class="reset-button" onclick="resetRecording()" style="display: none;">Play Again</button>
        <div class="reset-message" style="display: none;">
            Not satisfied with your performance? <br> Press the button below to record again.
        </div>
    </div>

    <div class="recording-info" id="recordingInfo">ğŸ“¢ You can record your instrument for 10 to 30 seconds only.</div>
</body>
</html>
